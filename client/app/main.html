<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>BB宝</title>

<script src="jquery-1.9.1.js"></script>
<script src="socket.io.js"></script>
<script src="nodeim.js"></script>
<link rel="stylesheet" type="text/css" href="styles/webim.css" />
<link rel="stylesheet" type="text/css" href="styles/webimpage.css" />


<script src="contextmenu/jquery.contextMenu.js"></script>
<link rel="stylesheet" type="text/css" href="contextmenu/jquery.contextMenu.css" />

 <link rel="stylesheet" href="jquery-ui.css" />
 <script src="jquery-ui.js"></script>
  
</head>
<body onselectstart="return false;">

	<div id="windowBorder" class="wWindowBorder" style=" width: 260px; height: 550px; display: none;"></div>
	
	<div class="wMain" id="wMain"
		style="position: absolute;  width: 260px; height: 550px; z-index: -500; left:0px;top:0px">
		<div class="wRound_lt"></div>
		<div class="wRound_rt"></div>
		<div class="wRound_lb"></div>
		<div class="wRound_rb"></div>
		<div class="wResize"></div>
		<div class="wContent">
			<div class="wMainTitle" style="color: rgb(153, 153, 153);" onmousedown="kate.window.drag()">
				<div class="wIcon">
					<img src="images/im/icon.png">
				</div>
				<div class="wText" >
					<span >BB宝</span>
				</div>
				
				<div class="wControl" >
					<div class="wControlMin" onmouseover="this.scrollTop='13'"
						onmouseout="this.scrollTop='0'">
						<img src="images/im/maincontrolmin.png" title="最小化" onclick="kate.window.minimize()">
					</div>
					<div class="wControlClose" onmouseover="this.scrollTop='15'"
						onmouseout="this.scrollTop='0'">
						<img src="images/im/maincontrolclose.png" title="关闭" onclick="kate.window.close();kate.parentWindow.close();nodeim.logout()">
					</div>
				</div>
			</div>
			<div class="wWindowContent"
				style="background-color: transparent; height: 525px;">
				<div class="wMainTool">
					<div class="wMainUserInfo">
						<div class="wMainUserFaceBG">
							<img
								src="images/default.gif"
								style="width: 51px; height: 51px; cursor: pointer"
								id="facePic" >
						</div>
						<div class="wMainUserInfoRight" style="width: 178px;">
							<div style="width: 100%; float: left">
								<div class="wMainUserName">
									<span><span id="title_Username">xx</span> <span style="font-size: 12px; color: #fff" onclick="menuUserNameToggle()">[<apan id="statusDiv">在线</apan>]</span></span>
									<img src="images/im/arrowdown.png" style="padding-left: 3px" onclick="menuUserNameToggle()">
								</div>
								<div id="menuUserName" class="sysMenu"
								style="width: 120px; height: 199px; top: 60px; left: 100px; display: none;">
								<div onselectstart="return false;" class="sysMenuItemWithIcon"
									onmouseover="this.className='sysMenuItemWithIcon sysMenuItemHover'"
									onmouseout="this.className='sysMenuItemWithIcon'"
									style="background-image: url(images/im/m0.png)"
									onclick="selectMenuUserName('在线')">在线</div>
								<div onselectstart="return false;" class="sysMenuItemWithIcon"
									onmouseover="this.className='sysMenuItemWithIcon sysMenuItemHover'"
									onmouseout="this.className='sysMenuItemWithIcon'"
									style="background-image: url(images/im/m1.png)"
									onclick="selectMenuUserName('忙碌')">忙碌</div>
								<div onselectstart="return false;" class="sysMenuItemWithIcon"
									onmouseover="this.className='sysMenuItemWithIcon sysMenuItemHover'"
									onmouseout="this.className='sysMenuItemWithIcon'"
									style="background-image: url(images/im/m2.png)"
									onclick="selectMenuUserName('马上回来')">马上回来</div>
								<div onselectstart="return false;" class="sysMenuItemWithIcon"
									onmouseover="this.className='sysMenuItemWithIcon sysMenuItemHover'"
									onmouseout="this.className='sysMenuItemWithIcon'"
									style="background-image: url(images/im/m2.png)"
									onclick="selectMenuUserName('离开')">离开</div>
								<div onselectstart="return false;" class="sysMenuItemWithIcon"
									onmouseover="this.className='sysMenuItemWithIcon sysMenuItemHover'"
									onmouseout="this.className='sysMenuItemWithIcon'"
									style="background-image: url(images/im/m2.png)"
									onclick="selectMenuUserName('通话中')">通话中</div>
								<div onselectstart="return false;" class="sysMenuItemWithIcon"
									onmouseover="this.className='sysMenuItemWithIcon sysMenuItemHover'"
									onmouseout="this.className='sysMenuItemWithIcon'"
									style="background-image: url(images/im/m2.png)"
									onclick="selectMenuUserName('外出就餐')">外出就餐</div>
								<div onselectstart="return false;" class="sysMenuItemWithIcon"
									onmouseover="this.className='sysMenuItemWithIcon sysMenuItemHover'"
									onmouseout="this.className='sysMenuItemWithIcon'"
									style="background-image: url(images/im/m3.png)"
									onclick="selectMenuUserName('我很忙')">我很忙</div>
								<div onselectstart="return false;" class="sysMenuItemWithIcon"
									onmouseover="this.className='sysMenuItemWithIcon sysMenuItemHover'"
									onmouseout="this.className='sysMenuItemWithIcon'"
									style="background-image: url(images/im/m3.png)"
									onclick="selectMenuUserName('隐身')">隐身</div>
							</div>
							</div>
							<div style="width: 100%; float: left">
								<div class="wMainUserSign" title="点击修改"></div>
							</div>
						</div>
					</div>
				</div>
				<div class="wMainSearchUserPannel">
					<div style="float: left; padding: 3px 8px 0px 6px; width: 155px;">
						<input title="通过输入姓名或邮箱来查找联系人"
							style="padding-right: 15px; width: 145px;"
							class="wMainSearchUserBG" type="text" id="searchText">
					</div>
					<div style="padding-top: 4px">
						<div class="wMainContentButton"
							onmouseover="this.className='wMainContentButton wMainContentButtonHover'"
							onmouseout="this.className='wMainContentButton'" onclick="openusersWindowKey()">
							<img src="images/searchicon-hover.png"
								style="height: 16px; width: 16px" title="搜索联系人">
						</div>
						<div class="wMainContentButton"
							onmouseover="this.className='wMainContentButton wMainContentButtonHover'"
							onmouseout="this.className='wMainContentButton'" onclick="openusersWindow()">
							<img src="images/im/tooladdfriend.png"
								style="height: 16px; width: 16px" title="添加联系人">
						</div>
						<div class="wMainContentButton"
							onmouseover="this.className='wMainContentButton wMainContentButtonHover'"
							onmouseout="this.className='wMainContentButton'" onclick="openRoomsWindow()">
							<img src="images/toolmanage.gif"
								style="height: 16px; width: 16px" title="创建聊天室">
						</div>
					</div>
				</div>
				<div class="wMainMain" onselectstart="return false"
					style="height: 374px;" >
					
					<div id="groupList">
						<div class="wMainUserHeaderEx" id="defaultGroup" groupName="默认分组" onclick="toggleFriend(this)">默认分组 ( <span id="defaultGroupNum" class="groupNum">0</span> )</div>
						<div class="wMainUserContainer" style="min-height: 26px" id="defaultGroupList">
							<div class="wMainUserItemText noFriend" style="padding-left: 25px; width: 100%; color: #aca899">此组中没有联系人</div>
	<!-- 							<div class="wMainUserItem" style="width:100%" > -->
	<!-- 							<div class="wMainListButton"' > -->
	<!-- 							<img src="images/im/m3.png" title="查看此人的联系人卡片" -->
	<!-- 							style="height: 19px; width: 19px" -->
	<!-- 							onclick=""> -->
	<!-- 							</div> -->
	<!-- 							<div class="wMainUserItemText">ddd&nbsp;&nbsp;<span style="color: #777"></span> -->
	<!-- 							</div> -->
	<!-- 							</div> -->
						</div>
					</div>
					<div class="wMainUserHeaderRoomsEx" id="rooms" groupName="聊天室列表" onclick="toggleFriendRooms(this)">聊天室列表 ( <span id="roomsNum" class="roomsNum">0</span> )</div>
					<div class="wMainUserContainer" style="min-height: 26px" id="roomsList">
					</div>
				</div>
				<div class="wMainSearchWebPannel">
					<div class="wMainToolBar">
<!-- 						<div class="wMainToolButton" -->
<!-- 							onmouseover="this.className='wMainToolButton wMainToolButtonHover'" -->
<!-- 							onmouseout="this.className='wMainToolButton'"> -->
<!-- 							<img src="images/im/toolshowfocus.png" -->
<!-- 								style="height: 25px; width: 25px" title="打开今日焦点"> -->
<!-- 						</div> -->
						<div class="wMainToolButton"
							onmouseover="this.className='wMainToolButton wMainToolButtonHover'"
							onmouseout="this.className='wMainToolButton'" onclick="openEditWindow()">
							<img src="images/im/toolprofile.png"
								style="height: 27px; width: 23px" title="编辑个人资料">
						</div>
						<div class="wMainToolButton"
							onmouseover="this.className='wMainToolButton wMainToolButtonHover'"
							onmouseout="this.className='wMainToolButton'" onclick="shotScreen()">
							<img src="images/im/tooloption.png"
								style="height: 24px; width: 25px" title="截屏">
						</div>
						<div class="wMainToolButton"
							onmouseover="this.className='wMainToolButton wMainToolButtonHover'"
							onmouseout="this.className='wMainToolButton'"
							style="display: none">
							<img src="images/toolmanage.gif"
								style="height: 16px; width: 17px" title="管理">
						</div>
					</div>
				</div>
				<input type="text"
					style="position: absolute; top: 58px; left: 75px; height: 14px; width: 175px; border: 1px solid rgb(127, 157, 185); display: none;">
					<img
					style="display: none; position: absolute; top: 139px; right: 63px; height: 8px; width: 8px; cursor: pointer"
					title="点击此处清除文本" src="images/close.gif"
					onmouseover="this.src='images/closehover.gif'"
					onmouseout="this.src='images/close.gif'">
			</div>
		</div>
		<div class="wLoading" style="display: none;">加载中...</div>
	</div>
	
	
 




	<script>
	
	//jQuery("body").append('<br/><br/><br/><br/><br/><br/><iframe id="ii" src="chat.htm" width="100%" height="500px" frameborder="0"></iframe>');
	
	function shotScreen(){
		alert("确认后开始截屏")
		
		setTimeout(function(){
			kate.shotScreen()
		},200);
		
		
		
	}
	
	function openChatWindow(id,username,facePath,callback){
		
		for(var i=0;i<nodeim.chatWindowArr.length;i++){
			if( nodeim.chatWindowArr[i].id == id){
				nodeim.chatWindowArr[i].window.show();
				return true;
			}
		}
		
		var chatObj = {};
		chatObj.id = id;
		chatObj.username = username;
		chatObj.facePath = facePath;
		chatObj.window = kate.createWindow(kate.appFolder+'/chat.html') ;
		chatObj.window.resize(554,495) ;
		chatObj.window.setFlags( 0x00000800 ) ;
		chatObj.window.show();
		chatObj.wndId = chatObj.window.wndId;
		chatObj.callback = callback;
		
		nodeim.chatWindowArr.push(chatObj);
		
		return chatObj.window;
	}
	
	function openRoomWindow(id,name,callback){
		
		for(var i=0;i<nodeim.roomWindowArr.length;i++){
			if( nodeim.roomWindowArr[i].id == id){
				nodeim.roomWindowArr[i].window.show();
				return true;
			}
		}
		
		var chatObj = {};
		chatObj.id = id;
		chatObj.name = name;
		chatObj.window = kate.createWindow(kate.appFolder+'/chatroom.html') ;
		chatObj.window.resize(695,495) ;
		chatObj.window.setFlags( 0x00000800 ) ;
		chatObj.window.show();
		chatObj.wndId = chatObj.window.wndId;
		chatObj.callback = callback;
		
		nodeim.roomWindowArr.push(chatObj);
		
		return chatObj.window;
	}
	
	function openChatWindow_CallBack( wndId ){
		
		for(var i=0;i<nodeim.chatWindowArr.length;i++){
			if( nodeim.chatWindowArr[i].wndId == wndId){
				
				nodeim.chatWindowArr[i].window.call("initUser",[nodeim.chatWindowArr[i]]);
				nodeim.chatWindowArr[i].window.call("initLocalUser",[nodeim.localUser]);
				
				if(typeof nodeim.chatWindowArr[i].callback == 'function')
				{
					nodeim.chatWindowArr[i].callback(nodeim.chatWindowArr[i].window);
				}
			}
		}
	}
	function openRoomWindow_CallBack( wndId ){
		
		
		for(var i=0;i<nodeim.roomWindowArr.length;i++){
			if( nodeim.roomWindowArr[i].wndId == wndId){
				
				var nowRoomWindow = nodeim.roomWindowArr[i].window;
				nowRoomWindow.call("initRoom",[nodeim.roomWindowArr[i]]);
				nowRoomWindow.call("initLocalUser",[nodeim.localUser]);
				
				nodeim.listRoom(nodeim.roomWindowArr[i].id,function(rs){
					
					nowRoomWindow.call("initUserList",[rs]);
				});
				
				
				if(typeof nodeim.roomWindowArr[i].callback == 'function')
				{
					nodeim.roomWindowArr[i].callback(nodeim.roomWindowArr[i].window);
				}
			}
		}
	}
	var find1Window = null;
	var find2Window = null;
	function openusersWindow(){
		
		find2Window = kate.createWindow(kate.appFolder+'/add2.html') ;
		find2Window.resize(370,300) ;
		find2Window.setFlags( 0x00000800 ) ;
		find2Window.hide();
		

		find1Window = kate.createWindow(kate.appFolder+'/add1.html') ;
		find1Window.resize(359,289) ;
		find1Window.setFlags( 0x00000800 ) ;
		
		find1Window.show();
	}
	function openusersWindowKey(){
		
		if( jQuery("#searchText").val() == ""){
			alert("请输入要搜索好友的名字")
			return;
		}

		find1Window = kate.createWindow(kate.appFolder+'/add1.html') ;
		find1Window.resize(359,289) ;
		find1Window.setFlags( 0x00000800 ) ;
		
		find2Window = kate.createWindow(kate.appFolder+'/add2.html') ;
		find2Window.resize(370,300) ;
		find2Window.setFlags( 0x00000800 ) ;
		find2Window.hide();
		
		nodeim.searchUser({
			//id : parseInt(jQuery("#searchText").val())
			username : jQuery("#searchText").val()
		});
			
	}


	var editWindow = null;
	function openEditWindow(){
		editWindow = kate.createWindow(kate.appFolder+'/edit.html') ;
		editWindow.resize(338,526) ;
		editWindow.setFlags( 0x00000800 ) ;
		editWindow.show();
	}

	var roomsWindow = null;
	function openRoomsWindow(){
		roomsWindow = kate.createWindow(kate.appFolder+'/addrooms.html') ;
		roomsWindow.resize(214,124) ;
		roomsWindow.setFlags( 0x00000800 ) ;
		roomsWindow.show();
	}
	
	
	function menuUserNameToggle(){
		
		if( jQuery("#menuUserName").css("display")=="none"){
			
			jQuery("body").mousedown(function(e){

				
				var DivLeft = parseInt(jQuery("#menuUserName").css("left"));
				var DivTop = parseInt(jQuery("#menuUserName").css("top"));
				var DivHeight = parseInt(jQuery("#menuUserName").css("height"));
				var DivWidth = parseInt(jQuery("#menuUserName").css("width"));

				if( e.clientX < DivLeft || e.clientX > (DivLeft+DivWidth) || e.clientY < DivTop || e.clientY > (DivTop+DivWidth)){
					jQuery("#menuUserName").hide();
					jQuery("body").unbind("mousedown");
				}
			});
			
			jQuery("#menuUserName").show();
		}else{
			jQuery("#menuUserName").hide();

			
		}
		
		
	}
	function selectMenuUserName(sStatus){
		menuUserNameToggle();
		nodeim.status(sStatus, function(){
			jQuery("#statusDiv").text( sStatus)
			
			if( sStatus != "在线"){
				
			}else{
				
			}
		});
	}
	
	
	function toggleFriend(obj){
	
		if( jQuery(obj).attr("class") == "wMainUserHeaderEx ui-droppable"){
			
			jQuery(obj).next().hide();
			jQuery(obj).attr("class" , "wMainUserHeader");
		}else{

			jQuery(obj).next().show();
			jQuery(obj).attr("class" , "wMainUserHeaderEx ui-droppable");
		}
	}
	function toggleFriendRooms(obj){
	
		if( jQuery(obj).attr("class") == "wMainUserHeaderRoomsEx"){
			
			jQuery(obj).next().hide();
			jQuery(obj).attr("class" , "wMainUserHeader");
		}else{

			jQuery(obj).next().show();
			jQuery(obj).attr("class" , "wMainUserHeaderRoomsEx");
		}
	}
	function setBjcolor(obj){
		
		jQuery(".wMainUserItem,.wMainUserItemRooms").each(function(){
			jQuery(this).css("background-color","");
		})
		jQuery(obj).css("background-color","rgb(255, 239, 176)");
	};

	
	
	jQuery(".wMainTitle").mousedown(function(e){
		
		return ;
		
		var bs = jQuery("#windowBorder");
		var _me = jQuery("#wMain");
		
		bs.css("top" , parseInt(jQuery("#wMain").css("top")) +"px");
		bs.css("left" , parseInt(jQuery("#wMain").css("left")) +"px");
		bs.css("width" , parseInt(jQuery("#wMain").width()+"px"));
		bs.css("height" , parseInt(jQuery("#height").width()+"px"));
		
		bs.show();
		var chaLeft = e.clientX - parseInt(_me.css("left"));
		var chaTop = e.clientY - parseInt(_me.css("top"));
		document.body.style.cursor = "move";
		document.onmousemove = function(e)
		{
			bs.css("left" ,(e.clientX-chaLeft) +"px");
			bs.css("top" , (e.clientY-chaTop) +"px");
		};
		document.onmouseup = function()
		{
			_me.css("left",bs.css("left"));
			_me.css("top",bs.css("top"));
			document.body.style.cursor = "";
			document.onmousemove = document.onmouseup = null;
			jQuery("#windowBorder").hide();
		};
	});
	
	jQuery(".wResize").mousedown(function(e){

			return ;
		
			var bs = jQuery("#windowBorder");
			var _me = jQuery("#wMain");

			bs.css("top" , parseInt(jQuery("#wMain").css("top")) +"px");
			bs.css("left" , parseInt(jQuery("#wMain").css("left")) +"px");
			bs.css("width" , parseInt(jQuery("#wMain").width()+"px"));
			bs.css("height" , parseInt(jQuery("#height").width()+"px"));
			bs.show();
			

			var _oldCentX = e.clientX;
			var _oldCentY = e.clientY;
			
			document.body.style.cursor = "SE-resize";
			document.onmousemove = function(e)
			{
				bs.css("width",(e.clientX-parseInt(_me.css("top")))+"px");
				bs.css("height",(e.clientY-parseInt(_me.css("left")))+"px");
			};
			document.onmouseup = function(e)
			{
				//jQuery(".wMainUserInfoRight").css("width", parseInt(jQuery(".wMainUserInfoRight").css("width")) + (e.clientX - _oldCentX) );
				
				_me.css("height" , parseInt((parseInt(  bs.css("height")  ))/2)*2 );
				_me.css("width" , parseInt((parseInt(  bs.css("width")  ))/2)*2 );
				
				document.body.style.cursor = "";
				document.onmousemove = document.onmouseup = null;
				bs.hide();
			};
	});
	


	var createGroupWindow = null;
	function openCreateGroupWindow(){
		createGroupWindow = kate.createWindow(kate.appFolder+'/addgroup.html') ;
		createGroupWindow.resize(214,124) ;
		createGroupWindow.setFlags( 0x00000800 ) ;
		createGroupWindow.show();
	}
	
	$(function(){
		
	    $.contextMenu({
	        selector: '.wMainUserItem', 
	        callback: function(key, options) {

	        	if( key == "delete"){
	        		
					nodeim.removeUser( jQuery(this).attr("uid"));
		        	
	        	}
	        },
	        items: {
	            "delete": {name: "删除好友", icon: "delete"}
	        }
	    });
	    $.contextMenu({
	        selector: '.wMainUserItemRooms', 
	        callback: function(key, options) {

	        	if( key == "delete"){
	        		
	        		nodeim.leaveRoom( jQuery(this).attr("roomid"));
		        	
	        	}
	        },
	        items: {
	            "delete": {name: "退出聊天室", icon: "delete"}
	        }
	    });
	    $.contextMenu({
	        selector: '.wMainUserHeaderEx', 
	        callback: function(key, options) {
	            
	        	if( key == "create"){

		        	openCreateGroupWindow();
	        	}
	        	if( key == "delete"){
	        		
					nodeim.deleteGroup( jQuery(this).attr("groupName"));
		        	
	        	}
	        	
	            
	        },
	        items: {
	            "create": {name: "增加分组", icon: "add"},
	            "delete": {name: "删除分组", icon: "delete"}
	        }
	    });

	 
	});
	
	
	function onKateLoaded(){

		// 屏幕截图快捷键
		window.onKateGlobalKeyEvent = function(keys){
			console.log("emit global keys: ",keys) ;
			if(keys.toLowerCase()=='ctrl+alt+a')
			{
				kate.shotScreen() ;
			}
		}
		// 注册快捷键
		kate.window.regGlobalKeyEvent("CTRL+ALT+A") ;
	}
	</script>
</body>
</html>
